{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-diagram-3 text-primary"></i> [1단계: 권역설계] {{ survey.survey_name }}</h2>
        <div class="d-flex gap-2">
            <a href="{% url 'design_list' %}" class="btn btn-outline-secondary btn-sm">목록으로</a>
            <button class="btn btn-primary btn-sm px-4 shadow" onclick="saveAreaTree()">권역 설계 최종 저장</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-dark text-white fw-bold">권역 레벨 정의</div>
                <div class="card-body">
                    <p class="small text-muted">조사에서 사용할 계층 레벨을 정의하세요.</p>
                    <ul class="list-group list-group-flush" id="level-list">
                        <li class="list-group-item d-flex justify-content-between align-items-center small bg-light" id="lv-1">
                            Lv.1 본청 <span class="badge bg-secondary">필수</span>
                        </li>
                    </ul>
                    <button class="btn btn-outline-dark btn-sm w-100 mt-3" onclick="addLevel()">+ 하위 레벨 추가</button>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                    <span class="fw-bold"><i class="bi bi-list-nested me-2"></i>권역 트리 구조 관리</span>
                    <button class="btn btn-success btn-sm fw-bold" onclick="addRootNode()">+ 최상위 권역(본청) 추가</button>
                </div>
                <div class="card-body bg-light" id="tree-container" style="min-height: 500px;">
                    <div id="area-tree-root"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 서버 데이터 로드
const savedAreas = [
    {% for area in areas %}
    {
        id: "{{ area.id }}",
        parent_id: "{{ area.parent_id|default:'' }}",
        code: "{{ area.area_code }}",
        name: "{{ area.area_name }}",
        level: {{ area.level }}
    },
    {% endfor %}
];

// 레벨 카운트 초기화 (최소 1)
let currentLevelCount = savedAreas.length > 0 ? Math.max(...savedAreas.map(a => a.level)) : 1;

document.addEventListener('DOMContentLoaded', () => {
    // 1. 저장된 레벨만큼 왼쪽 목록 채우기
    for(let i=2; i<=currentLevelCount; i++) renderLevelItem(i);
    
    // 2. 저장된 트리 데이터 렌더링
    if (savedAreas.length > 0) renderExistingTree();
});

/* --- 레벨 관리 함수 --- */
function addLevel() {
    currentLevelCount++;
    renderLevelItem(currentLevelCount);
}

function renderLevelItem(lv) {
    const list = document.getElementById('level-list');
    list.insertAdjacentHTML('beforeend', `
        <li class="list-group-item d-flex justify-content-between align-items-center small" id="lv-${lv}">
            Lv.${lv} 하위 레벨 
            <button class="btn btn-link text-danger p-0" onclick="removeLevel(${lv})"><i class="bi bi-x-circle"></i></button>
        </li>
    `);
}

function removeLevel(lv) {
    if(confirm(`Lv.${lv} 이상의 모든 하위 노드가 생성되지 않을 수 있습니다. 레벨을 삭제할까요?`)) {
        document.getElementById(`lv-${lv}`).remove();
        // 실제 저장 시 레벨 정보를 다시 계산하므로 UI에서만 삭제
    }
}

/* --- 노드 생성 함수 (통합본) --- */
function createNodeHtml(tempId, level, defaultName, parentTempId) {
    return `
        <div class="area-node ms-${level > 1 ? 4 : 0} mb-2 p-2 border rounded bg-white shadow-sm" 
             id="node-${tempId}" data-temp-id="${tempId}" data-level="${level}" data-parent-id="${parentTempId}">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-info">Lv.${level}</span>
                <input type="text" class="form-control form-control-sm fw-bold w-25 border-warning" placeholder="코드" id="code-${tempId}">
                <input type="text" class="form-control form-control-sm w-50" placeholder="권역명" id="name-${tempId}">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-success" title="하위 추가" onclick="addChildNode('${tempId}', ${level + 1})">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-outline-danger" title="삭제" onclick="removeNode('${tempId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div id="children-${tempId}" class="mt-2 border-start ms-3 ps-2" style="border-color: #dee2e6 !important;"></div>
        </div>
    `;
}

/* --- 트리 조작 함수 --- */
function addRootNode() {
    const rootContainer = document.getElementById('area-tree-root');
    const tempId = 'NEW_' + Date.now();
    rootContainer.insertAdjacentHTML('beforeend', createNodeHtml(tempId, 1, "", ""));
}

function addChildNode(parentTempId, level) {
    const levelItems = document.querySelectorAll('#level-list li');
    if (level > levelItems.length) {
        alert(`현재 ${levelItems.length}레벨까지만 정의되어 있습니다. 왼쪽에서 레벨을 먼저 추가해주세요.`);
        return;
    }
    const childContainer = document.getElementById(`children-${parentTempId}`);
    const tempId = 'NEW_' + Date.now() + Math.random();
    childContainer.insertAdjacentHTML('beforeend', createNodeHtml(tempId, level, "", parentTempId));
}

function removeNode(tempId) {
    if(confirm("이 권역과 하위 권역을 모두 삭제할까요?")) {
        document.getElementById(`node-${tempId}`).remove();
    }
}

/* --- 데이터 로드 및 저장 --- */
function renderExistingTree() {
    const rootContainer = document.getElementById('area-tree-root');
    rootContainer.innerHTML = '';
    
    // 부모-자식 관계를 유지하며 렌더링하기 위해 레벨 순으로 정렬 보장
    const sortedAreas = [...savedAreas].sort((a, b) => a.level - b.level);

    sortedAreas.forEach(area => {
        const html = createNodeHtml(area.id, area.level, area.name, area.parent_id);
        if (!area.parent_id) {
            rootContainer.insertAdjacentHTML('beforeend', html);
        } else {
            const parentContainer = document.getElementById(`children-${area.parent_id}`);
            if (parentContainer) parentContainer.insertAdjacentHTML('beforeend', html);
        }
        document.getElementById(`code-${area.id}`).value = area.code;
        document.getElementById(`name-${area.id}`).value = area.name;
    });
}

async function saveAreaTree() {
    const nodes = document.querySelectorAll('.area-node');
    const payload = Array.from(nodes).map(node => {
        const tid = node.dataset.tempId;
        return {
            temp_id: tid,
            parent_temp_id: node.dataset.parentId || null,
            level: node.dataset.level,
            code: document.getElementById(`code-${tid}`).value,
            name: document.getElementById(`name-${tid}`).value
        };
    });

    if(payload.some(p => !p.code || !p.name)) {
        return alert("모든 권역의 코드와 명칭을 입력해주세요.");
    }

    const res = await fetch(window.location.href, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ areas: payload })
    });
    
    if(res.ok) {
        alert("권역 설계가 최종 저장되었습니다.");
        location.reload();
    }
}
</script>
{% endblock %}