{% extends 'base.html' %}
{% load survey_tags %}

{% block content %}
<tbody>
    {% for data in data_list %}
    <tr>
        <td><code>{{ data.respondent_id }}</code></td>
        {% for h in headers %}
        <td>{{ data.list_values|dict_get:h.id }}</td>
        {% endfor %}
        <td><span class="badge bg-info text-dark" id="status-{{ data.id }}">{{ data.status }}</span></td>
        <td>
            <button class="btn btn-primary btn-sm" onclick="openSurveyPopup({{ data.id }})">입력하기</button>
        </td>
    </tr>
    {% endfor %}
</tbody>

<div class="modal fade" id="entryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="entryFormTitle">조사표 입력</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="entry-container" style="max-height: 70vh; overflow-y: auto;">
                </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button class="btn btn-success" onclick="submitSurveyData()">입력 완료 저장</button>
            </div>
        </div>
    </div>
</div>

<script>
let activeDataId = null;

async function openSurveyPopup(dataId) {
    activeDataId = dataId;
    const response = await fetch(`/data/${dataId}/get-survey/`);
    const data = await response.json();

    if(data.status === 'error') return alert(data.message);

    document.getElementById('entryFormTitle').innerText = data.form_name;
    const container = document.getElementById('entry-container');
    container.innerHTML = '';

    // 설계 정보(Q)를 바탕으로 입력 폼(A) 렌더링
    data.design_data.forEach((q, idx) => {
        const savedVal = data.saved_values[q.id] || ''; // 기존 저장값 확인
        
        let inputHtml = '';
        if(q.type === 'radio') {
            const opts = q.options.split(',').map(o => o.trim());
            inputHtml = opts.map(o => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input answer-input" type="radio" name="${q.id}" value="${o}" ${savedVal === o ? 'checked' : ''}>
                    <label class="form-check-label">${o}</label>
                </div>`).join('');
        } else if(q.type === 'number') {
            inputHtml = `<input type="number" class="form-control answer-input" data-id="${q.id}" value="${savedVal}">`;
        } else {
            inputHtml = `<input type="text" class="form-control answer-input" data-id="${q.id}" value="${savedVal}">`;
        }

        const section = `
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body">
                    <div class="fw-bold mb-2">Q${idx + 1}. ${q.label}</div> <div class="p-2 bg-white rounded border">
                        <small class="text-muted d-block mb-1">A${idx + 1}. 답변</small>
                        ${inputHtml}
                    </div>
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', section);
    });

    new bootstrap.Modal(document.getElementById('entryModal')).show();
}

async function submitSurveyData() {
    const answers = {};
    // 모든 입력 필드 값 수집
    document.querySelectorAll('.answer-input').forEach(input => {
        if(input.type === 'radio') {
            if(input.checked) answers[input.name] = input.value;
        } else {
            answers[input.dataset.id] = input.value;
        }
    });

    const response = await fetch(`/data/${activeDataId}/save-survey/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ answers: answers })
    });
    
    const result = await response.json();
    if(result.status === 'success') {
        alert('저장되었습니다.');
        document.getElementById(`status-${activeDataId}`).innerText = 'ING';
        bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
    }
}
</script>
{% endblock %}