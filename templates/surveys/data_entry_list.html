{% extends 'base.html' %}
{% load survey_tags %}

{% block content %}
<style>
    /* 내검 관련 스타일 유지 */
    .text-validation-warning { color: #b45309 !important; font-weight: 600; }
    .text-validation-error { color: #dc3545 !important; font-weight: 700; }
    #error-list li { cursor: pointer; transition: background 0.2s; }
    #error-list li:hover { background-color: #fff5f5; text-decoration: underline; }

    .highlight-error {
        animation: highlight-fade 2s ease-in-out;
        border: 2px solid #dc3545 !important;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
    @keyframes highlight-fade {
        0% { background-color: #ffebeb; }
        100% { background-color: transparent; }
    }

    /* 리스트 가독성 향상 */
    .table-responsive { border-radius: 8px; }
    .badge-status { min-width: 60px; }
    
    /* 권역 검색바 전용 스타일 */
    .area-filter-card { background-color: #f8f9fa; border: 1px solid #dee2e6; }
</style>

<div class="container-fluid mt-4 px-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'collection_list' %}">조사목록</a></li>
            <li class="breadcrumb-item active">{{ roster.roster_name }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1"><i class="bi bi-card-checklist me-2 text-primary"></i>{{ roster.roster_name }} 수집 현황</h3>
            <p class="text-muted small mb-0">접속 권역: <strong>{{ user_area.area_name|default:"전체" }}</strong> (조사원: {{ request.user.username }})</p>
        </div>
        <span class="badge bg-secondary px-3 py-2">총 {{ data_list|length }}건</span>
    </div>

    {% if is_area_design_exists %}
    <div class="card mb-3 area-filter-card border-0 shadow-sm">
        <div class="card-body p-3">
            <form method="get" id="areaSearchForm" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-secondary">1단계 (본청)</label>
                    <select name="sel_lv1" id="sel_lv1" class="form-select form-select-sm" 
                            {% if user_level > 1 %}disabled{% endif %}>
                        <option value="">-- 전체 --</option>
                        {% for a in lv1_list %}
                        <option value="{{ a.id }}" data-code="{{ a.area_code }}" {% if sel_lv1 == a.id|stringformat:"s" %}selected{% endif %}>{{ a.area_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-secondary">2단계 (지방청)</label>
                    <select name="sel_lv2" id="sel_lv2" class="form-select form-select-sm"
                            {% if user_level > 2 %}disabled{% endif %}>
                        <option value="">-- 전체 --</option>
                        {% for a in lv2_list %}
                        {% comment %} 상위 코드와 매칭하기 위해 data-parent-code 설정 {% endcomment %}
                        <option value="{{ a.id }}" 
                                data-parent-code="{{ a.area_code|slice:":2" }}" 
                                data-code="{{ a.area_code }}" 
                                {% if sel_lv2 == a.id|stringformat:"s" %}selected{% endif %}>{{ a.area_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-secondary">3단계 (사무소)</label>
                    <select name="sel_lv3" id="sel_lv3" class="form-select form-select-sm">
                        <option value="">-- 전체 --</option>
                        {% for a in lv3_list %}
                        <option value="{{ a.id }}" 
                                data-parent-code="{{ a.area_code|slice:":4" }}" 
                                {% if sel_lv3 == a.id|stringformat:"s" %}selected{% endif %}>{{ a.area_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark btn-sm w-100 fw-bold">
                        <i class="bi bi-geo-alt me-1"></i>권역 검색
                    </button>
                </div>
                <div class="col-md-1">
                    <a href="?" class="btn btn-outline-secondary btn-sm w-100">초기화</a>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if search_fields %}
    <div class="card mb-4 bg-light border-0 shadow-sm">
        <div class="card-body p-3">
            <form method="get" class="row g-2">
                {% for field in search_fields %}
                <div class="col-md-3">
                    <label class="form-label small fw-bold mb-1 text-secondary">{{ field.label }}</label>
                    <input type="text" name="{{ field.id }}" class="form-control form-control-sm" 
                           value="{{ request.GET|dict_get:field.id }}" placeholder="검색어">
                </div>
                {% endfor %}
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">
                        <i class="bi bi-search me-1"></i>데이터 조회
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-center">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 100px;">레코드ID</th>
                        <th style="width: 150px;">권역</th>
                        <th style="width: 130px;">담당 조사원</th>
                        {% for h in headers %}
                        <th>{{ h.label }}</th>
                        {% endfor %}
                        <th style="width: 100px;">진행상태</th>
                        <th style="width: 120px;">자료 입력</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in data_list %}
                    <tr>
                        <td><code>{{ data.respondent_id }}</code></td>
                        <td>
                            <div class="fw-bold">{{ data.area.area_name }}</div>
                            <small class="text-muted">{{ data.area.area_code }}</small>
                        </td>
                        <td>
                            {% if data.assigned_user %}
                                <span class="badge bg-outline-primary text-primary border border-primary fw-normal">
                                    <i class="bi bi-person-fill"></i> {{ data.assigned_user.username }}
                                </span>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        
                        {% for h in headers %}
                        <td class="small">
                            {% if h.id == 'area_code' %}
                                {{ data.area.area_code }}
                            {% else %}
                                {{ data.list_values|dict_get:h.id }}
                            {% endif %}
                        </td>
                        {% endfor %}
                        
                        <td>
                            <span class="badge badge-status {% if data.status == 'READY' %}bg-secondary{% else %}bg-success{% endif %}">
                                {{ data.status }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm px-3 shadow-sm" onclick="openSurveyPopup({{ data.id }})">
                                <i class="bi bi-pencil-square me-1"></i>입력
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="100" class="py-5 text-muted">조회된 명부 데이터가 없습니다.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="entryModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header bg-primary text-white py-2">
                <div>
                    <h5 class="modal-title fw-bold" id="entryFormTitle">통계 데이터 입력</h5>
                    <small id="respondentInfo" class="opacity-75"></small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-0">
                <div id="validation-error-area" class="d-none m-3">
                    <div class="alert alert-danger shadow-sm p-0 overflow-hidden">
                        <div class="bg-danger text-white px-3 py-2 small fw-bold">
                            <i class="bi bi-exclamation-octagon-fill me-2"></i>논리 내검 오류 내역
                        </div>
                        <div class="bg-white">
                            <ul id="error-list" class="list-group list-group-flush mb-0 small"></ul>
                        </div>
                    </div>
                </div>
                <div class="bg-white border-bottom px-3 pt-2">
                    <ul class="nav nav-tabs border-0" id="surveyTab" role="tablist"></ul>
                </div>
                <div class="tab-content p-4" id="surveyTabContent" style="min-height: 400px;"></div>
            </div>
            <div class="modal-footer bg-white border-top">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                <button id="btnSaveAll" class="btn btn-success px-4 fw-bold" onclick="submitSurveyData()">
                    입력 내용 저장
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * 1. 계층형 권역 선택 Cascade 로직
 */
document.addEventListener('DOMContentLoaded', function() {
    const lv1 = document.getElementById('sel_lv1');
    const lv2 = document.getElementById('sel_lv2');
    const lv3 = document.getElementById('sel_lv3');

    function updateLv2() {
        if(!lv1 || !lv2) return;
        const selectedCode = lv1.options[lv1.selectedIndex]?.getAttribute('data-code') || "";
        Array.from(lv2.options).forEach(opt => {
            if (opt.value === "") opt.style.display = "block";
            else opt.style.display = opt.getAttribute('data-parent-code') === selectedCode ? "block" : "none";
        });
    }

    function updateLv3() {
        if(!lv2 || !lv3) return;
        const selectedCode = lv2.options[lv2.selectedIndex]?.getAttribute('data-code') || "";
        Array.from(lv3.options).forEach(opt => {
            if (opt.value === "") opt.style.display = "block";
            else opt.style.display = opt.getAttribute('data-parent-code') === selectedCode ? "block" : "none";
        });
    }

    if(lv1) lv1.addEventListener('change', () => { 
        if(lv2) lv2.value = ""; 
        if(lv3) lv3.value = ""; 
        updateLv2(); 
        updateLv3(); 
    });
    
    if(lv2) lv2.addEventListener('change', () => { 
        if(lv3) lv3.value = ""; 
        updateLv3(); 
    });
    
    // 페이지 로드 시 선택된 값 기준으로 필터링 적용
    updateLv2();
    updateLv3();
});

/**
 * 2. 자료 수집 및 팝업 로직 (기존 유지)
 */
let activeDataId = null;
let activeVerFormIds = []; 
let activeEditRules = [];

async function openSurveyPopup(dataId) {
    activeDataId = dataId;
    try {
        const res = await fetch(`/data/${dataId}/get-survey/`);
        const data = await res.json();
        activeEditRules = data.edit_rules || [];
        if(data.status === 'error') return alert(data.message);

        document.getElementById('respondentInfo').innerText = `대상: ${data.respondent_id} | ${data.survey_year}년 ${data.survey_degree}차`;
        
        const tabList = document.getElementById('surveyTab');
        const tabContent = document.getElementById('surveyTabContent');
        tabList.innerHTML = ''; tabContent.innerHTML = '';
        activeVerFormIds = [];

        data.forms.forEach((form, idx) => {
            const isActive = idx === 0 ? 'active' : '';
            const isShow = idx === 0 ? 'show active' : '';
            activeVerFormIds.push(form.ver_form_id);

            tabList.insertAdjacentHTML('beforeend', `
                <li class="nav-item">
                    <button class="nav-link ${isActive} fw-bold" data-bs-toggle="tab" data-bs-target="#tab-${form.q_id}" type="button">
                        ${form.form_name}
                    </button>
                </li>`);

            let qHtml = `<div class="alert alert-light border py-1 small mb-3">조사표 버전: ${form.ver_form_id}</div>`;
            form.design_data.forEach((q, qIdx) => { 
                qHtml += renderQuestionRow(q, qIdx, form.ver_form_id, form.saved_values[q.id]); 
            });

            tabContent.insertAdjacentHTML('beforeend', `
                <div class="tab-pane fade ${isShow}" id="tab-${form.q_id}" role="tabpanel">
                    ${qHtml}
                </div>`);
        });
        new bootstrap.Modal(document.getElementById('entryModal')).show();
    } catch (e) { alert("데이터 로드 중 오류 발생"); }
}

function renderQuestionRow(q, idx, verFormId, savedVal) {
    let inputHtml = '';
    const nameAttr = `name="${verFormId}_${q.id}"`;
    if(q.type === 'radio') {
        const opts = q.options ? q.options.split(',') : [];
        inputHtml = opts.map(o => `
            <div class="form-check form-check-inline">
                <input class="form-check-input answer-input" type="radio" ${nameAttr} data-form-id="${verFormId}" data-q-id="${q.id}" value="${o.trim()}" ${savedVal == o.trim() ? 'checked' : ''}>
                <label class="form-check-label small">${o.trim()}</label>
            </div>`).join('');
    } else if(q.type === 'checkbox') {
        const opts = q.options ? q.options.split(',') : [];
        const savedArray = Array.isArray(savedVal) ? savedVal : (savedVal ? [savedVal] : []);
        inputHtml = opts.map(o => `
            <div class="form-check form-check-inline">
                <input class="form-check-input answer-input" type="checkbox" ${nameAttr} data-form-id="${verFormId}" data-q-id="${q.id}" value="${o.trim()}" ${savedArray.includes(o.trim()) ? 'checked' : ''}>
                <label class="form-check-label small">${o.trim()}</label>
            </div>`).join('');
    } else {
        inputHtml = `<input type="text" class="form-control form-control-sm answer-input" data-form-id="${verFormId}" data-q-id="${q.id}" value="${savedVal || ''}" autocomplete="off">`;
    }
    return `
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body py-3">
                <div class="fw-bold mb-2 small text-primary">Q${idx+1}. ${q.label}</div>
                <div class="p-2 bg-white rounded border-top">${inputHtml}</div>
            </div>
        </div>`;
}

async function submitSurveyData() {
    const allAnswers = {};
    activeVerFormIds.forEach(id => allAnswers[id] = {});
    document.querySelectorAll('.answer-input').forEach(input => {
        const formId = input.dataset.formId;
        const qId = input.dataset.qId;
        if (input.type === 'radio' && input.checked) allAnswers[formId][qId] = input.value;
        else if (input.type === 'checkbox') {
            if (!allAnswers[formId][qId]) allAnswers[formId][qId] = [];
            if (input.checked) allAnswers[formId][qId].push(input.value);
        } 
        else if (input.type === 'text') allAnswers[formId][qId] = input.value;
    });

    const errors = runValidation(allAnswers);
    if (errors.some(e => e.severity === 'ERROR')) {
        alert("입력 데이터에 논리적 오류가 있습니다.");
        return;
    }

    if (!confirm("저장하시겠습니까?")) return;

    const btnSave = document.getElementById('btnSaveAll');
    btnSave.disabled = true;
    try {
        const response = await fetch(`/data/${activeDataId}/save-survey/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ answers: allAnswers })
        });
        const result = await response.json();
        if(result.status === 'success') {
            alert('저장 완료.');
            location.reload(); 
        }
    } catch (error) {
        alert('서버 통신 오류');
    } finally { btnSave.disabled = false; }
}

function runValidation(allAnswers) {
    const errors = [];
    const errorListUI = document.getElementById('error-list');
    const errorArea = document.getElementById('validation-error-area');
    errorListUI.innerHTML = '';
    errorArea.classList.add('d-none');

    activeEditRules.forEach(rule => {
        if (!rule.condition || !rule.target_form_id) return;
        try {
            const matchedVerId = activeVerFormIds.find(id => id.startsWith(rule.target_form_id));
            if (!matchedVerId) return;
            const context = allAnswers[matchedVerId] || {};
            const evalExpr = rule.condition.replace(/\{(\w+)\}/g, (match, key) => {
                const val = context[key];
                if (val === undefined || val === null || val === '') return "''";
                return isNaN(val) ? `'${val}'` : val;
            });
            if (new Function(`return ${evalExpr}`)()) {
                errors.push({ message: rule.message, target: rule.target_field, target_ver_id: matchedVerId, severity: rule.severity });
            }
        } catch (e) { console.error("Rule Error:", e); }
    });

    if (errors.length > 0) {
        errorArea.classList.remove('d-none');
        errors.forEach(err => {
            const li = document.createElement('li');
            li.className = `list-group-item list-group-item-action py-2 border-0 ${err.severity === 'ERROR' ? 'text-validation-error' : 'text-validation-warning'}`;
            li.innerHTML = `<i class="bi bi-caret-right-fill"></i> [${err.severity}] ${err.message}`;
            li.onclick = () => focusTargetField(err.target_ver_id, err.target);
            errorListUI.appendChild(li);
        });
    }
    return errors;
}

function focusTargetField(verFormId, fieldId) {
    const inputEl = document.querySelector(`[data-form-id="${verFormId}"][data-q-id="${fieldId}"]`);
    if (!inputEl) return;
    const pane = inputEl.closest('.tab-pane');
    if (pane) {
        const tabTrigger = document.querySelector(`[data-bs-target="#${pane.id}"]`);
        if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
    }
    setTimeout(() => {
        inputEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        inputEl.focus();
        const card = inputEl.closest('.card');
        if (card) {
            card.classList.add('highlight-error');
            setTimeout(() => card.classList.remove('highlight-error'), 2000);
        }
    }, 300);
}
</script>
{% endblock %}