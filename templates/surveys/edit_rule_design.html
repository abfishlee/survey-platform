{% extends 'base.html' %}
{% load survey_tags %}

{% block content %}
<style>
    /* 시인성 강화를 위한 커스텀 스타일 */
    .table-rule thead th { background-color: #f8f9fa; color: #333; font-weight: 700; border-top: 2px solid #333; }
    .severity-error { color: #dc3545; font-weight: bold; }
    .severity-warning { color: #fd7e14; font-weight: bold; }
    /* 조건식 입력란 강조 */
    .input-condition { background-color: #fffdf0 !important; border: 1px solid #ffda6a !important; }
    .input-condition:focus { background-color: #fff !important; border-color: #ffc107 !important; box-shadow: 0 0 0 0.25 red; }
</style>

<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-shield-check text-danger"></i> [4단계: 내검규칙설계] <span class="text-primary">{{ survey.survey_name }}</span></h2>
        <div class="d-flex gap-2">
            <a href="{% url 'design_list' %}" class="btn btn-outline-secondary btn-sm">목록으로</a>
            <button class="btn btn-danger btn-sm px-4 shadow" onclick="saveRules()"><i class="bi bi-cloud-upload"></i> 내검 규칙 최종 저장</button>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
            <span class="fw-bold"><i class="bi bi-list-check me-2"></i>데이터 논리성 체크 규칙 (Editing Rules)</span>
            <button class="btn btn-warning btn-sm fw-bold" onclick="addRule()">+ 규칙 추가</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0 text-center">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">규칙ID</th>
                            <th style="width: 180px;">대상 조사표</th> <th style="width: 180px;">대상 문항</th>
                            <th>내검 조건식 (논리식)</th>
                            <th>에러 메시지</th>
                            <th style="width: 120px;">심각도</th>
                            <th style="width: 60px;">삭제</th>
                        </tr>
                    </thead>
                    <tbody id="rule-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="alert alert-light border shadow-sm">
        <h6 class="fw-bold text-dark"><i class="bi bi-info-circle-fill text-info me-2"></i>내검 식 작성 가이드</h6>
        <div class="row small text-muted">
            <div class="col-md-6">
                <li>일반 문항 참조: <strong>{q1}</strong> (항목 ID를 중괄호로 감싸서 입력)</li>
                <li><strong class="text-primary">테이블 셀 참조:</strong> <code>{table_id}[행인덱스][열ID]</code></li>
                <li>연산자: <code>and, or, not, ==, !=, >, <</code> (파이썬 문법 사용)</li>
            </div>
            <div class="col-md-6">
                <li>일반 예시: <code>{age} < 15 and {marriage} == '1'</code></li>
                <li><strong class="text-primary">테이블 예시:</strong> <code>{q6}[0][q6_1] == '1'</code> (originId 사용, 1행, q6_1열이 1이어야 함)</li>
                <li><strong>Error</strong>: 저장 불가 / <strong>Warning</strong>: 확인 후 저장 가능</li>
            </div>
        </div>
        <div class="mt-2 p-2 bg-warning-subtle rounded border border-warning">
            <small class="text-dark fw-bold"><i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>테이블 셀 참조 주의사항:</small>
            <ul class="mb-0 small text-dark">
                <li>행 인덱스는 <strong>0부터 시작</strong>합니다 (1행 = 0, 2행 = 1, ...)</li>
                <li>열ID는 테이블 설계 시 정의한 <strong>서브항목(subItems)의 ID</strong>를 사용합니다</li>
                <li>테이블 ID는 <strong>originId</strong>를 사용할 수 있습니다 (예: <code>q6</code>)</li>
                <li>실제 예시: <code>{q6}[0][q6_1] == '1'</code> (originId가 <code>q6</code>인 테이블의 1행 1열이 1이어야 함)</li>
            </ul>
        </div>
    </div>
</div>

<script>
// 데이터 로드
let editRules = {{ edit_rules|json_encode|safe|default:"[]" }};
const itemPool = {{ item_pool|json_encode|safe|default:"[]" }};

// 테이블 타입 문항 찾기
function findTableItem(itemId) {
    return itemPool.find(item => item.id === itemId && (item.type === 'table' || item.type === 'mapping-table'));
}

// 플레이스홀더 생성 함수
function getPlaceholder(targetFieldId) {
    if (!targetFieldId) return "{q1} == '1'";
    const item = itemPool.find(i => i.id === targetFieldId);
    if (item && (item.type === 'table' || item.type === 'mapping-table')) {
        // 테이블인 경우: 1행, 2열 예시 (행인덱스 0, 첫 번째 서브항목 ID 사용)
        // originId 사용 (있는 경우)
        const tableId = item.originId || item.id;
        const subItems = item.subItems || [];
        const colId = subItems.length > 1 ? subItems[1].id : (subItems.length > 0 ? subItems[0].id : 'col1');
        return `{${tableId}}[0][${colId}] == '1'`;
    }
    // 일반 필드도 originId 사용 (있는 경우)
    const fieldId = item?.originId || targetFieldId;
    return `{${fieldId}} == '1'`;
}

document.addEventListener('DOMContentLoaded', renderRules);

function renderRules() {
    const tbody = document.getElementById('rule-tbody');
    tbody.innerHTML = '';

    if (editRules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">등록된 내검 규칙이 없습니다. [규칙 추가] 버튼을 눌러주세요.</td></tr>';
        return;
    }

    editRules.forEach((rule, idx) => {
        tbody.innerHTML += `
            <tr>
                <td class="bg-light">
                    <input type="text" class="form-control form-control-sm text-center fw-bold border-0 bg-transparent" 
                           value="${rule.rule_id || 'ERR_'+(idx+1)}" onchange="updateRule(${idx}, 'rule_id', this.value)">
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateRule(${idx}, 'target_form_id', this.value)">
                        <option value="">-- 조사표 선택 --</option>
                        {% for q in questionnaires %}
                        <option value="{{ q.form_id }}" ${rule.target_form_id === '{{ q.form_id }}' ? 'selected' : ''}>
                            {{ q.form_name }} ({{ q.form_id }})
                        </option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateRule(${idx}, 'target_field', this.value); renderRules();">
                        <option value="">-- 문항 선택 --</option>
                        ${itemPool.map(item => {
                            const isTable = item.type === 'table' || item.type === 'mapping-table';
                            const tableBadge = isTable ? ' <span class="badge bg-primary">테이블</span>' : '';
                            return `<option value="${item.id}" ${rule.target_field === item.id ? 'selected' : ''}>${item.label} (${item.id})${tableBadge}</option>`;
                        }).join('')}
                    </select>
                    ${(() => {
                        const selectedItem = itemPool.find(i => i.id === rule.target_field);
                        if (selectedItem && (selectedItem.type === 'table' || selectedItem.type === 'mapping-table')) {
                            const subItems = selectedItem.subItems || [];
                            if (subItems.length > 0) {
                                return `<small class="text-primary d-block mt-1">
                                    <i class="bi bi-info-circle"></i> 열 정보: ${subItems.map((sub, idx) => `${idx+1}열=${sub.id}`).join(', ')}
                                </small>`;
                            }
                        }
                        return '';
                    })()}
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm font-monospace input-condition" 
                           value="${rule.condition || ''}" 
                           placeholder="${getPlaceholder(rule.target_field)}" 
                           onchange="updateRule(${idx}, 'condition', this.value)"
                           title="일반 문항: {q1} == '1'&#10;테이블 셀: {q6}[0][q6_1] == '1' (originId 사용)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${rule.message || ''}" placeholder="에러 메시지 입력" 
                           onchange="updateRule(${idx}, 'message', this.value)">
                </td>
                <td>
                    <select class="form-select form-select-sm ${rule.severity === 'ERROR' ? 'severity-error' : 'severity-warning'}" 
                            onchange="updateRule(${idx}, 'severity', this.value); renderRules();">
                        <option value="ERROR" ${rule.severity === 'ERROR' ? 'selected' : ''}>Error</option>
                        <option value="WARNING" ${rule.severity === 'WARNING' ? 'selected' : ''}>Warning</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-link text-danger p-0 border-0" onclick="removeRule(${idx})">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            </tr>
        `;
    });
}

function addRule() {
    // target_form_id 초기값 추가
    editRules.push({ 
        rule_id: `ERR_${editRules.length + 1}`, 
        target_form_id: '', 
        target_field: '', 
        condition: '', 
        message: '', 
        severity: 'ERROR' 
    });
    renderRules();
}

function updateRule(idx, field, value) { editRules[idx][field] = value; }

function removeRule(idx) {
    if(confirm('이 규칙을 삭제하시겠습니까?')) {
        editRules.splice(idx, 1);
        renderRules();
    }
}

async function saveRules() {
    const res = await fetch(window.location.href, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ edit_rules: editRules })
    });
    const result = await res.json();
    if(res.ok) {
        alert("내검 규칙이 성공적으로 저장되었습니다.");
        location.reload();
    }
}
</script>
{% endblock %}