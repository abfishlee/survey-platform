{% extends 'base.html' %}
{% load survey_tags %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-gear-wide-connected"></i> [1단계: 항목설계] {{ survey.survey_name }}</h2>
        <div class="d-flex gap-2">
            <a href="{% url 'design_list' %}" class="btn btn-outline-secondary">목록으로</a>
            <button type="button" class="btn btn-primary shadow-sm" onclick="saveDesign()">항목 저장</button>
        </div>
    </div>

    <ul class="nav nav-tabs" id="designTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-schema" type="button" role="tab">명부 항목 정의</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="survey-tab" data-bs-toggle="tab" data-bs-target="#survey-schema" type="button" role="tab">조사표 문항 정의</button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-4 bg-white shadow-sm rounded-bottom" id="designTabContent">
        <div class="tab-pane fade show active" id="list-schema" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="text-secondary">명부 항목 속성 정의</h5>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItem('list')">+ 신규 항목 추가</button>
            </div>
            <div id="list-container"></div>
        </div>

        <div class="tab-pane fade" id="survey-schema" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="text-secondary">조사표 문항 속성 정의</h5>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="addItem('survey')">+ 조사 문항 추가</button>
            </div>
            <div id="survey-container"></div>
        </div>
    </div>
</div>

<script>
/**
 * 1. 데이터 초기화
 */
let listSchema = {{ list_fields|json_encode|safe|default:"[]" }};
let surveySchema = {{ survey_questions|json_encode|safe|default:"[]" }};

document.addEventListener('DOMContentLoaded', () => {
    try {
        renderItems('list');
        renderItems('survey');
    } catch (e) {
        console.error("초기 렌더링 중 오류:", e);
    }
});

/**
 * 2. 항목 추가 함수
 */
function addItem(type) {
    const uniqueId = `item_${Date.now()}`;
    
    if (type === 'list') {
        listSchema.push({ id: uniqueId, label: '신규 항목', type: 'text', length: 50 });
    } else {
        // 테이블 관련 기본 속성 추가
        surveySchema.push({ 
            id: uniqueId, 
            label: '신규 질문', 
            type: 'text', 
            options: '',
            columns: ['항목1', '항목2'], // 테이블 기본 컬럼
            useRowHeaders: false,
            rowLabels: ''
        });
    }
    renderItems(type);
}

/**
 * 3. 화면 렌더링 함수
 */
function renderItems(type) {
    const container = document.getElementById(`${type}-container`);
    const data = (type === 'list') ? listSchema : surveySchema;
    
    if (!container) return;
    container.innerHTML = '';

    if (data.length === 0) {
        container.innerHTML = '<div class="text-center py-5 text-muted border rounded bg-light">등록된 항목이 없습니다.</div>';
        return;
    }

    data.forEach((item, index) => {
        if (type === 'list') {
            container.innerHTML += `
                <div class="row g-2 mb-2 align-items-end border p-3 rounded bg-light shadow-sm">
                    <div class="col-md-3">
                        <label class="small fw-bold text-primary">ID (물리명)</label>
                        <input type="text" class="form-control form-control-sm" value="${item.id}" onchange="updateItemValue('list', ${index}, 'id', this.value)">
                    </div>
                    <div class="col-md-4">
                        <label class="small fw-bold">항목명 (논리명)</label>
                        <input type="text" class="form-control form-control-sm" value="${item.label}" onchange="updateItemValue('list', ${index}, 'label', this.value)">
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold">타입</label>
                        <select class="form-select form-select-sm" onchange="updateItemValue('list', ${index}, 'type', this.value)">
                            <option value="text" ${item.type==='text'?'selected':''}>문자</option>
                            <option value="number" ${item.type==='number'?'selected':''}>숫자</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="small fw-bold">길이</label>
                        <input type="number" class="form-control form-control-sm" value="${item.length || 50}" onchange="updateItemValue('list', ${index}, 'length', this.value)">
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="removeItem('${type}', ${index})">
                            <i class="bi bi-trash"></i> 삭제
                        </button>
                    </div>
                </div>`;
        } else {
            const isChoice = ['radio', 'checkbox'].includes(item.type);
            const isTable = item.type === 'table';

            container.innerHTML += `
                <div class="row g-2 mb-3 align-items-end border p-3 rounded shadow-sm" style="background-color: ${isTable ? '#f0f4ff' : '#f8fff9'};">
                    <div class="col-md-2">
                        <label class="small fw-bold text-success">문항ID</label>
                        <input type="text" class="form-control form-control-sm" value="${item.id}" onchange="updateItemValue('survey', ${index}, 'id', this.value)">
                    </div>
                    <div class="col-md-5">
                        <label class="small fw-bold text-success">질문 내용</label>
                        <input type="text" class="form-control form-control-sm" value="${item.label}" onchange="updateItemValue('survey', ${index}, 'label', this.value)">
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold text-success">응답 형식</label>
                        <select class="form-select form-select-sm" onchange="changeSurveyType(${index}, this.value)">
                            <option value="text" ${item.type==='text'?'selected':''}>단답형</option>
                            <option value="number" ${item.type==='number'?'selected':''}>숫자형</option>
                            <option value="radio" ${item.type==='radio'?'selected':''}>객관식(단일)</option>
                            <option value="checkbox" ${item.type==='checkbox'?'selected':''}>객관식(중복)</option>
                            <option value="table" ${item.type==='table'?'selected':''}>표/테이블</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="removeItem('${type}', ${index})">
                            <i class="bi bi-trash"></i> 삭제
                        </button>
                    </div>

                    ${isChoice ? `
                    <div class="col-12 mt-2">
                        <label class="small fw-bold text-muted">선택지 (콤마[,]로 구분)</label>
                        <input type="text" class="form-control form-control-sm" value="${item.options || ''}" onchange="updateItemValue('survey', ${index}, 'options', this.value)" placeholder="예: 예, 아니오, 모르겠다">
                    </div>` : ''}

                    ${isTable ? `
                    <div class="col-12 mt-2 p-2 border rounded bg-white shadow-sm">
                        <div class="row g-2">
                            <div class="col-md-12">
                                <label class="small fw-bold text-primary"><i class="bi bi-table"></i> 열(Header) 설정 (콤마[,]로 구분)</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${Array.isArray(item.columns) ? item.columns.join(', ') : item.columns}" 
                                       onchange="updateTableField(${index}, 'columns', this.value)" 
                                       placeholder="예: 이름, 나이, 성별">
                            </div>
                            <div class="col-md-4 mt-2">
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="rowHead_${index}" 
                                           ${item.useRowHeaders ? 'checked' : ''} 
                                           onchange="updateTableField(${index}, 'useRowHeaders', this.checked)">
                                    <label class="form-check-label small fw-bold" for="rowHead_${index}">표측(행 머리글) 사용</label>
                                </div>
                            </div>
                            <div class="col-md-8 mt-2" id="rowLabelsBox_${index}" style="display: ${item.useRowHeaders ? 'block' : 'none'}">
                                <label class="small fw-bold text-primary">표측(왼쪽 질의) 입력 (콤마[,]로 구분)</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${Array.isArray(item.rowLabels) ? item.rowLabels.join(', ') : item.rowLabels}" 
                                       onchange="updateTableField(${index}, 'rowLabels', this.value)" 
                                       placeholder="예: 가구주, 배우자, 자녀1">
                            </div>
                        </div>
                    </div>` : ''}
                </div>`;
        }
    });
}

/**
 * 4. 테이블 전용 필드 업데이트 유틸리티
 */
function updateTableField(index, field, value) {
    if (field === 'useRowHeaders') {
        surveySchema[index][field] = value;
        // 스위치 켜짐/꺼짐에 따라 표측 라벨 입력창 표시 제어
        document.getElementById(`rowLabelsBox_${index}`).style.display = value ? 'block' : 'none';
    } else {
        // 콤마로 구분된 입력을 배열로 변환
        surveySchema[index][field] = value.split(',').map(s => s.trim()).filter(s => s !== '');
    }
}

function updateItemValue(type, index, field, value) {
    if (type === 'list') {
        listSchema[index][field] = value;
    } else {
        surveySchema[index][field] = value;
    }
}

function changeSurveyType(index, value) {
    surveySchema[index].type = value;
    // 테이블 타입으로 변경 시 초기 배열 구조 보장
    if (value === 'table') {
        if (!surveySchema[index].columns) surveySchema[index].columns = ['항목1', '항목2'];
        if (surveySchema[index].useRowHeaders === undefined) surveySchema[index].useRowHeaders = false;
        if (!surveySchema[index].rowLabels) surveySchema[index].rowLabels = [];
    }
    renderItems('survey');
}

function removeItem(type, index) {
    if (!confirm('정말 삭제하시겠습니까?')) return;
    if (type === 'list') {
        listSchema.splice(index, 1);
    } else {
        surveySchema.splice(index, 1);
    }
    renderItems(type);
}

/**
 * 5. 최종 저장 기능
 */
async function saveDesign() {
    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ 
                list_schema: listSchema, 
                survey_schema: surveySchema 
            })
        });
        const result = await response.json();
        if (response.ok) {
            alert(result.message || "성공적으로 저장되었습니다.");
            location.reload();
        } else {
            alert("저장 실패");
        }
    } catch (e) {
        alert("서버 통신 중 오류가 발생했습니다.");
    }
}
</script>
{% endblock %}