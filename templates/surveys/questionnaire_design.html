{% extends 'base.html' %}
{% load survey_tags %}

{% load django_vite %}
{% block content %}
{{ item_pool|json_script:"item-pool-data" }}

<div class="container-fluid py-4" style="max-width: 1400px;">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <h2 class="fs-4 fw-bold text-dark m-0">
            <i class="bi bi-pencil-square text-warning me-2"></i> [3단계: 조사표설계] {{ survey.survey_name }}
        </h2>
        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>목록으로
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 col-md-5">
            <div class="card border-warning shadow-sm mb-4">
                <div class="card-header bg-warning text-dark fw-bold"><i class="bi bi-plus-circle me-1"></i> 조사표 생성</div>
                <div class="card-body">
                    <select id="rosterSelect" class="form-select mb-2">
                        <option value="">--- 대상 명부 선택 ---</option>
                        {% for r in rosters %}<option value="{{ r.id }}">{{ r.roster_name }}</option>{% endfor %}
                    </select>
                    <input type="text" id="formName" class="form-control mb-2" placeholder="조사표 명칭">
                    <button class="btn btn-dark w-100 fw-bold" onclick="createQuestionnaire()">생성하기</button>
                </div>
            </div>
            
            <h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-list-task"></i> 조사표 목록</h6>
            <div class="list-group shadow-sm" style="max-height: 500px; overflow-y: auto;">
                {% for r in rosters %}
                    <div class="list-group-item bg-light fw-bold text-secondary">{{ r.roster_name }}</div>
                    {% for q in r.questionnaires.all %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="showVersions({{ q.id }}, '{{ q.form_name }}')">
                        <span class="text-truncate" style="max-width: 180px;">{{ q.form_name }}</span>
                        <div>
                            <button class="btn btn-primary btn-xs" onclick="event.stopPropagation(); openDesignModal({{ q.id }}, '{{ q.form_name }}')">설계</button>
                            <button class="btn btn-outline-danger btn-xs" onclick="event.stopPropagation(); deleteQuestionnaire({{ q.id }})"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="list-group-item text-center text-muted">등록된 조사표 없음</div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div id="version-panel" class="card shadow-sm h-100 border-0 bg-light" style="min-height: 500px;">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-muted" id="empty-msg">
                    <p>좌측 목록에서 조사표를 선택하세요.</p>
                </div>
                <div id="version-list-area" class="d-none w-100 h-100 d-flex flex-column">
                    <div class="card-header bg-white border-bottom"><h5 id="v-title" class="m-0 fs-6 fw-bold"></h5></div>
                    <div class="card-body p-0 overflow-auto">
                        <table class="table table-hover mb-0 text-center align-middle small">
                            <thead class="table-light"><tr><th>버전</th><th>일시</th><th>문항수</th><th>상태</th><th>관리</th></tr></thead>
                            <tbody id="v-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="designModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" style="padding-right: 0 !important;">
    <div class="modal-dialog modal-fullscreen" style="width: 100%; max-width: none; height: 100%; margin: 0;">
        <div class="modal-content" style="height: 100%; border: 0; border-radius: 0;">
            <div class="modal-body p-0" style="overflow: hidden;">
                <div id="app" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script>
let currentQId = null;
window.addEventListener('version-saved', (e) => { if(currentQId === e.detail.q_id) showVersions(e.detail.q_id, ''); });

async function createQuestionnaire() {
    const rid = document.getElementById('rosterSelect').value;
    const name = document.getElementById('formName').value;
    if(!rid || !name) return alert('입력 확인 필요');
    const res = await fetch(location.href, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'}, body:JSON.stringify({roster_id:rid, form_name:name})});
    if(res.ok) location.reload();
}

async function showVersions(qId, name) {
    currentQId = qId;
    document.getElementById('empty-msg').classList.add('d-none');
    document.getElementById('version-list-area').classList.remove('d-none');
    if(name) document.getElementById('v-title').innerText = `[${name}] 버전 관리`;
    const res = await fetch(`/questionnaire/${qId}/versions/`);
    const data = await res.json();
    document.getElementById('v-tbody').innerHTML = data.length ? data.map(v => `
        <tr><td class="fw-bold text-primary">V${v.version_number}</td><td>${v.created_at}</td><td>${v.item_count}</td>
        <td>${v.is_confirmed?'<span class="badge bg-success">확정</span>':'<span class="badge bg-secondary">작성중</span>'}</td>
        <td><button class="btn btn-primary btn-xs" onclick="openDesignModal(${qId}, '', ${JSON.stringify(v.design_data).replace(/"/g, '&quot;')}, ${v.id})">열기</button>
        ${!v.is_confirmed?`<button class="btn btn-success btn-xs ms-1" onclick="confirmVersion(${v.id})">확정</button>`:''}</td></tr>`).join('') : '<tr><td colspan="5">이력 없음</td></tr>';
}

async function confirmVersion(vId) {
    if(confirm('확정하시겠습니까?')) { await fetch(`/questionnaire/version/${vId}/confirm/`, {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}}); alert('완료'); showVersions(currentQId, ''); }
}

async function deleteQuestionnaire(qId) {
    if(confirm('삭제하시겠습니까?')) { await fetch(`/questionnaire/${qId}/delete/`, {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}}); location.reload(); }
}

function openDesignModal(id, name, data=[], vid=null) {
    currentQId = id;
    const pool = JSON.parse(document.getElementById('item-pool-data').textContent || '[]');
    new bootstrap.Modal(document.getElementById('designModal')).show();
    setTimeout(() => window.dispatchEvent(new CustomEvent('init-survey-editor', {detail:{surveyId:id, surveyName:name, initialData:data, versionId:vid, questionPool:pool}})), 300);
}
</script>

<!-- <script type="module" src="http://127.0.0.1:3000/@vite/client"></script>
<script type="module" src="http://127.0.0.1:3000/src/main.js"></script> -->

{% vite_hmr_client %}
{% vite_asset 'src/collector-main.js' %}
{% endblock %}