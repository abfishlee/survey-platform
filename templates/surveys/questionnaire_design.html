{% extends 'base.html' %}
{% load survey_tags %}
{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-pencil-square"></i> [3단계: 조사표설계] {{ survey.survey_name }}</h2>
        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary">목록으로</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 border-warning shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold">조사표 생성</div>
                <div class="card-body">
                    <select id="rosterSelect" class="form-select form-select-sm mb-2">
                        <option value="">--- 대상 명부 선택 ---</option>
                        {% for r in rosters %}<option value="{{ r.id }}">{{ r.roster_name }}</option>{% endfor %}
                    </select>
                    <input type="text" id="formName" class="form-control form-control-sm mb-2" placeholder="조사표 명칭 (예: 가구원 실태조사)">
                    <button class="btn btn-warning btn-sm w-100 fw-bold" onclick="createQuestionnaire()">조사표 신규 등록</button>
                </div>
            </div>
            
            <h6 class="fw-bold mb-3"><i class="bi bi-list-ul"></i> 등록된 조사표 목록</h6>
            <div class="list-group shadow-sm">
                {% for r in rosters %}
                    <div class="list-group-item list-group-item-light small fw-bold text-secondary">명부: {{ r.roster_name }}</div>
                    {% for q in r.questionnaires.all %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                         style="cursor: pointer;" onclick="showVersions({{ q.id }}, '{{ q.form_name }}')">
                        <div style="flex: 1;">
                            <strong>{{ q.form_name }}</strong> <small class="text-muted d-block">ID: {{ q.form_id }}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openDesignModal({{ q.id }}, '{{ q.form_name }}')">설계</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteQuestionnaire({{ q.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <div class="col-md-8">
            <div id="version-panel" class="card shadow-sm h-100 bg-white" style="min-height: 500px;">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-muted" id="empty-msg">
                    <i class="bi bi-clock-history display-4 mb-3"></i>
                    <p>왼쪽 리스트에서 조사표를 선택하면 저장된 버전 이력이 표시됩니다.</p>
                </div>
                <div id="version-list-area" class="d-none">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                        <h5 id="v-title" class="mb-0 fs-6"></h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 text-center align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>버전</th><th>저장일시</th><th>문항수</th><th>상태</th><th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="v-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="designModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="displayFormName">조사표 문항 설계</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 d-flex overflow-hidden">
                <div class="bg-light border-end p-3" style="flex: 2; overflow-y: auto;">
                    <h6 class="fw-bold border-bottom pb-2 text-primary"><i class="bi bi-plus-circle"></i> 문항 풀 (Pool)</h6>
                    <div id="pool-list">
                        {% for item in item_pool %}
                        <div class="form-check mb-2 small p-2 border rounded bg-white shadow-xs">
                            <input class="form-check-input item-check" type="checkbox" value="{{ item.id }}" 
                                   id="chk_{{ item.id }}" data-label="{{ item.label }}" data-type="{{ item.type }}" data-opts="{{ item.options }}"
                                   onchange="toggleQuestion('{{ item.id }}')">
                            <label class="form-check-label d-block" for="chk_{{ item.id }}">
                                <strong>{{ item.label }}</strong><br>
                                <code class="text-muted small">{{ item.id }}</code>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="p-4" style="flex: 8; overflow-y: auto; background-color: #f8f9fa;">
                    <div id="design-canvas"></div>
                </div>
            </div>
            <div class="modal-footer bg-light border-top">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                <button class="btn btn-success px-4 fw-bold" onclick="saveDesign()">신규 버전으로 저장</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentQId = null, currentDesign = [];

async function createQuestionnaire() {
    const rosterId = document.getElementById('rosterSelect').value, name = document.getElementById('formName').value;
    if(!rosterId || !name) return alert('명부와 조사표명을 모두 입력해주세요.');
    const res = await fetch(window.location.href, { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, 
        body: JSON.stringify({ roster_id: rosterId, form_name: name }) 
    });
    if(res.ok) location.reload();
}

async function showVersions(qId, name) {
    currentQId = qId;
    document.getElementById('empty-msg').classList.add('d-none');
    document.getElementById('version-list-area').classList.remove('d-none');
    document.getElementById('v-title').innerText = `[${name}] 버전 관리 리스트`;
    
    const res = await fetch(`/questionnaire/${qId}/versions/`);
    const data = await res.json();
    document.getElementById('v-tbody').innerHTML = data.map(v => `
        <tr>
            <td class="fw-bold text-primary">V${v.version_number}</td>
            <td><small>${v.created_at}</small></td>
            <td>${v.item_count}개</td>
            <td>${v.is_confirmed ? '<span class="badge bg-success">최종확정</span>' : '<span class="badge bg-light text-dark border">임시저장</span>'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick='loadDesign(${JSON.stringify(v.design_data)})'>조회</button>
                    ${!v.is_confirmed ? `<button class="btn btn-outline-success" onclick="confirmVersion(${v.id})">확정</button>` : ''}
                </div>
            </td>
        </tr>`).join('');
}

async function confirmVersion(vId) {
    if(!confirm("이 버전을 최종 확정할까요?\n확정된 버전은 자료수집 화면에 즉시 반영됩니다.")) return;
    const res = await fetch(`/questionnaire/version/${vId}/confirm/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
    if(res.ok) { alert('확정되었습니다.'); showVersions(currentQId, ''); }
}

function openDesignModal(id, name) {
    currentQId = id; currentDesign = [];
    document.getElementById('displayFormName').innerText = `[조사표 설계] ${name}`;
    document.querySelectorAll('.item-check').forEach(chk => chk.checked = false);
    renderCanvas();
    new bootstrap.Modal(document.getElementById('designModal')).show();
}

function loadDesign(data) {
    currentDesign = data;
    document.querySelectorAll('.item-check').forEach(chk => { 
        chk.checked = currentDesign.some(d => d.id === chk.value); 
    });
    renderCanvas();
    new bootstrap.Modal(document.getElementById('designModal')).show();
}

function toggleQuestion(id) {
    const chk = document.getElementById(`chk_${id}`);
    if(chk.checked) {
        currentDesign.push({ id: id, label: chk.dataset.label, type: chk.dataset.type, options: chk.dataset.opts });
    } else {
        currentDesign = currentDesign.filter(d => d.id !== id);
    }
    renderCanvas();
}

/**
 * 미리보기 캔버스 렌더링 (다중선택 및 ID 표시 추가)
 */
function renderCanvas() {
    const canvas = document.getElementById('design-canvas'); 
    canvas.innerHTML = '';
    
    if(currentDesign.length === 0) {
        canvas.innerHTML = '<div class="text-center py-5 text-muted border-dashed rounded">왼쪽 풀에서 문항을 선택하면 여기에 표시됩니다.</div>';
        return;
    }

    currentDesign.forEach((q, idx) => {
        let answerHtml = '';
        if (q.type === 'radio' || q.type === 'checkbox') {
            const opts = q.options ? q.options.split(',').map(o => o.trim()) : [];
            answerHtml = opts.map(o => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="${q.type}" disabled>
                    <label class="form-check-label small">${o}</label>
                </div>`).join('');
        } else {
            answerHtml = `<input type="text" class="form-control form-control-sm w-50" placeholder="입력란 예시" disabled>`;
        }

        canvas.insertAdjacentHTML('beforeend', `
            <div class="card mb-3 border-start border-4 border-primary shadow-sm">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-primary me-2">Q${idx + 1}</span>
                            <code class="text-muted small">${q.id}</code>
                        </div>
                        <small class="text-muted fw-bold">${q.type === 'checkbox' ? '[다중선택]' : '[단일/텍스트]'}</small>
                    </div>
                    <div class="mb-2">
                        <label class="small text-secondary mb-1">문항 질문 제목 (수정 가능)</label>
                        <input type="text" class="form-control form-control-sm fw-bold" value="${q.label}" onchange="updateQuestionLabel('${q.id}', this.value)">
                    </div>
                    <div class="bg-light p-2 border rounded">${answerHtml}</div>
                </div>
            </div>`);
    });
}

function updateQuestionLabel(id, value) { 
    const item = currentDesign.find(d => d.id === id); 
    if(item) item.label = value; 
}

async function saveDesign() {
    if(currentDesign.length === 0) return alert('설계된 문항이 없습니다.');
    
    const btnSave = document.querySelector('button[onclick="saveDesign()"]');
    btnSave.disabled = true; // 중복 클릭 방지

    try {
        const res = await fetch(`/questionnaire/${currentQId}/save/`, { 
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}'
            }, 
            body: JSON.stringify({ design_data: currentDesign }) 
        });
        
        const result = await res.json();
        
        if(res.ok && result.status === 'success') { 
            alert(`신규 버전(V${result.version})이 저장되었습니다.`); 
            location.reload(); 
        } else {
            // 서버에서 보낸 상세 에러 메시지 출력
            alert(`저장 실패: ${result.message || '알 수 없는 서버 오류'}`);
        }
    } catch (e) { 
        alert('통신 중 에러가 발생했습니다.'); 
        console.error(e);
    } finally {
        btnSave.disabled = false;
    }
}

async function deleteQuestionnaire(qId) {
    if (!confirm("조사표를 삭제하면 모든 버전 설계 이력이 영구히 삭제됩니다.\n정말 삭제하시겠습니까?")) return;
    const res = await fetch(`/questionnaire/${qId}/delete/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'}
    });
    if (res.ok) { alert('조사표가 삭제되었습니다.'); location.reload(); }
}
</script>
{% endblock %}