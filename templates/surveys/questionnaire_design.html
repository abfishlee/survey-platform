{% extends 'base.html' %}
{% load survey_tags %}
{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>[3단계: 조사표설계] {{ survey.survey_name }}</h2>
        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary">목록으로</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 border-warning shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold">조사표 생성</div>
                <div class="card-body">
                    <select id="rosterSelect" class="form-select form-select-sm mb-2">
                        <option value="">--- 명부 선택 ---</option>
                        {% for r in rosters %}<option value="{{ r.id }}">{{ r.roster_name }}</option>{% endfor %}
                    </select>
                    <input type="text" id="formName" class="form-control form-control-sm mb-2" placeholder="조사표명">
                    <button class="btn btn-warning btn-sm w-100" onclick="createQuestionnaire()">조사표 신규 등록</button>
                </div>
            </div>
            
            <h6 class="fw-bold mb-3">등록된 조사표 목록 (클릭 시 버전 확인)</h6>
            <div class="list-group shadow-sm">
                {% for r in rosters %}
                    {% for q in r.questionnaires.all %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-1" 
                         style="cursor: pointer;" onclick="showVersions({{ q.id }}, '{{ q.form_name }}')">
                        <div><strong>{{ q.form_name }}</strong> ({{ q.form_id }})</div>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openDesignModal({{ q.id }}, '{{ q.form_name }}')">설계</button>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <div class="col-md-8">
            <div id="version-panel" class="card shadow-sm h-100 bg-light" style="min-height: 500px;">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-muted" id="empty-msg">
                    <p>조사표를 선택하면 버전 이력이 표시됩니다.</p>
                </div>
                <div id="version-list-area" class="d-none">
                    <div class="card-header bg-dark text-white d-flex justify-content-between"><h5 id="v-title" class="mb-0"></h5></div>
                    <div class="card-body bg-white p-0">
                        <table class="table table-hover mb-0">
                            <thead class="table-light"><tr><th>버전</th><th>저장일시</th><th>문항수</th><th>상태</th><th>관리</th></tr></thead>
                            <tbody id="v-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="designModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="displayFormName">조사표 설계</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 d-flex overflow-hidden">
                <div class="bg-light border-end p-3" style="flex: 2; overflow-y: auto;">
                    <h6 class="fw-bold border-bottom pb-2">문항 풀 (Pool)</h6>
                    <div id="pool-list">
                        {% for item in item_pool %}
                        <div class="form-check mb-2 small">
                            <input class="form-check-input item-check" type="checkbox" value="{{ item.id }}" 
                                   id="chk_{{ item.id }}" data-label="{{ item.label }}" data-type="{{ item.type }}" data-opts="{{ item.options }}"
                                   onchange="toggleQuestion('{{ item.id }}')">
                            <label class="form-check-label" for="chk_{{ item.id }}">{{ item.label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="p-4" style="flex: 8; overflow-y: auto; background-color: #f8f9fa;"><div id="design-canvas"></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-success px-4" onclick="saveDesign()">신규 버전으로 저장</button></div>
        </div>
    </div>
</div>

<script>
let currentQId = null, currentDesign = [];

async function createQuestionnaire() {
    const rosterId = document.getElementById('rosterSelect').value, name = document.getElementById('formName').value;
    if(!rosterId || !name) return alert('입력 누락');
    const res = await fetch(window.location.href, { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ roster_id: rosterId, form_name: name }) });
    if(res.ok) location.reload();
}

async function showVersions(qId, name) {
    currentQId = qId;
    document.getElementById('empty-msg').classList.add('d-none');
    document.getElementById('version-list-area').classList.remove('d-none');
    document.getElementById('v-title').innerText = `[${name}] 버전 관리`;
    const res = await fetch(`/questionnaire/${qId}/versions/`);
    const data = await res.json();
    document.getElementById('v-tbody').innerHTML = data.map(v => `
        <tr>
            <td>V${v.version_number}</td>
            <td><small>${v.created_at}</small></td>
            <td>${v.item_count}개</td>
            <td>${v.is_confirmed ? '<span class="badge bg-success">최종확정</span>' : '<span class="badge bg-light text-dark border">저장됨</span>'}</td>
            <td>
                <button class="btn btn-outline-info btn-xs" onclick='loadDesign(${JSON.stringify(v.design_data)})'>조회</button>
                ${!v.is_confirmed ? `<button class="btn btn-outline-success btn-xs" onclick="confirmVersion(${v.id})">확정</button>` : ''}
            </td>
        </tr>`).join('');
}

async function confirmVersion(vId) {
    if(!confirm("이 버전을 최종 확정할까요?")) return;
    const res = await fetch(`/questionnaire/version/${vId}/confirm/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
    if(res.ok) { alert('확정되었습니다.'); showVersions(currentQId, ''); }
}

function openDesignModal(id, name) {
    currentQId = id; currentDesign = [];
    document.getElementById('displayFormName').innerText = `[신규 설계] ${name}`;
    document.querySelectorAll('.item-check').forEach(chk => chk.checked = false);
    renderCanvas();
    new bootstrap.Modal(document.getElementById('designModal')).show();
}

function loadDesign(data) {
    currentDesign = data;
    document.querySelectorAll('.item-check').forEach(chk => { chk.checked = currentDesign.some(d => d.id === chk.value); });
    renderCanvas();
    new bootstrap.Modal(document.getElementById('designModal')).show();
}

function toggleQuestion(id) {
    const chk = document.getElementById(`chk_${id}`);
    if(chk.checked) currentDesign.push({ id: id, label: chk.dataset.label, type: chk.dataset.type, options: chk.dataset.opts });
    else currentDesign = currentDesign.filter(d => d.id !== id);
    renderCanvas();
}

function renderCanvas() {
    const canvas = document.getElementById('design-canvas'); canvas.innerHTML = '';
    currentDesign.forEach((q, idx) => {
        let answerHtml = (q.type === 'radio' || q.type === 'checkbox') ? 
            q.options.split(',').map(o => `<div class="form-check form-check-inline"><input class="form-check-input" type="radio" disabled><label class="form-check-label small">${o.trim()}</label></div>`).join('') :
            `<input type="text" class="form-control form-control-sm w-50" disabled>`;
        canvas.insertAdjacentHTML('beforeend', `<div class="card mb-3 border-start border-4 border-primary shadow-sm"><div class="card-body py-2">
            <span class="badge bg-primary mb-2">Q${idx + 1}</span>
            <input type="text" class="form-control form-control-sm mb-2 fw-bold" value="${q.label}" onchange="updateQuestionLabel('${q.id}', this.value)">
            <div class="bg-white p-2 border rounded">${answerHtml}</div></div></div>`);
    });
}

function updateQuestionLabel(id, value) { const item = currentDesign.find(d => d.id === id); if(item) item.label = value; }

async function saveDesign() {
    const res = await fetch(`/questionnaire/${currentQId}/save/`, { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ design_data: currentDesign }) });
    if(res.ok) { alert('버전 저장 완료'); location.reload(); }
}
</script>
{% endblock %}