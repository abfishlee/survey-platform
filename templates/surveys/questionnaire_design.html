{% extends 'base.html' %}
{% load django_vite %}

{% load django_vite %} {% block content %}
{{ item_pool|json_script:"item-pool-data" }}

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fs-4"><i class="bi bi-pencil-square"></i> [3단계: 조사표설계] {{ survey.survey_name }}</h2>
        <a href="{% url 'design_list' %}" class="btn btn-sm btn-outline-secondary">목록으로</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 border-warning shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold py-2">조사표 생성</div>
                <div class="card-body p-3">
                    <select id="rosterSelect" class="form-select form-select-sm mb-2">
                        <option value="">--- 대상 명부 선택 ---</option>
                        {% for r in rosters %}<option value="{{ r.id }}">{{ r.roster_name }}</option>{% endfor %}
                    </select>
                    <input type="text" id="formName" class="form-control form-control-sm mb-2" placeholder="조사표 명칭 (예: 가구원 실태조사)">
                    <button class="btn btn-warning btn-sm w-100 fw-bold" onclick="createQuestionnaire()">조사표 신규 등록</button>
                </div>
            </div>
            
            <h6 class="fw-bold mb-3"><i class="bi bi-list-ul"></i> 등록된 조사표 목록</h6>
            <div class="list-group shadow-sm small">
                {% for r in rosters %}
                    <div class="list-group-item list-group-item-light fw-bold text-secondary py-1">명부: {{ r.roster_name }}</div>
                    {% for q in r.questionnaires.all %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                         onclick="showVersions({{ q.id }}, '{{ q.form_name }}')">
                        <div style="flex: 1; cursor: pointer;">
                            <strong>{{ q.form_name }}</strong> <small class="text-muted d-block">ID: {{ q.form_id }}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openDesignModal({{ q.id }}, '{{ q.form_name }}')">설계</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteQuestionnaire({{ q.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <div class="col-md-8">
            <div id="version-panel" class="card shadow-sm h-100 bg-white" style="min-height: 500px;">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-muted" id="empty-msg">
                    <i class="bi bi-clock-history display-4 mb-3"></i>
                    <p>왼쪽 리스트에서 조사표를 선택하면 저장된 버전 이력이 표시됩니다.</p>
                </div>
                <div id="version-list-area" class="d-none w-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                        <h5 id="v-title" class="mb-0 fs-6"></h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 text-center align-middle small">
                            <thead class="table-light">
                                <tr>
                                    <th>버전</th><th>저장일시</th><th>문항수</th><th>상태</th><th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="v-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="designModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div id="app">
                <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">조사표 작업대를 불러오는 중임...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script>
let currentQId = null;

// [실시간 갱신] Vue 작업대에서 '저장' 성공 신호를 보내면 목록을 다시 불러옴
window.addEventListener('version-saved', (event) => {
    const savedQId = event.detail.q_id;
    if (currentQId === savedQId) {
        showVersions(savedQId, ''); // 목록만 즉시 갱신
    }
});

// 조사표 신규 등록
async function createQuestionnaire() {
    const rosterId = document.getElementById('rosterSelect').value;
    const name = document.getElementById('formName').value;
    if(!rosterId || !name) return alert('명부와 조사표명을 모두 입력해주세요.');
    const res = await fetch(window.location.href, { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, 
        body: JSON.stringify({ roster_id: rosterId, form_name: name }) 
    });
    if(res.ok) location.reload();
}

// 특정 조사표의 버전 목록 조회 (AJAX)
async function showVersions(qId, name) {
    currentQId = qId;
    document.getElementById('empty-msg').classList.add('d-none');
    document.getElementById('version-list-area').classList.remove('d-none');
    
    if (name) {
        document.getElementById('v-title').innerText = `[${name}] 버전 관리 리스트`;
    }
    
    const res = await fetch(`/questionnaire/${qId}/versions/`);
    const data = await res.json();
    
    document.getElementById('v-tbody').innerHTML = data.map(v => `
        <tr>
            <td class="fw-bold text-primary">V${v.version_number}</td>
            <td><small>${v.created_at}</small></td>
            <td>${v.item_count}개</td>
            <td>${v.is_confirmed ? 
                '<span class="badge bg-success">최종확정</span>' : 
                '<span class="badge bg-light text-dark border">임시저장</span>'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" 
                            onclick="openDesignModal(${qId}, '', ${JSON.stringify(v.design_data).replace(/"/g, '&quot;')}, ${v.id})">조회/수정</button>
                    ${!v.is_confirmed ? `<button class="btn btn-outline-success" onclick="confirmVersion(${v.id})">확정</button>` : ''}
                </div>
            </td>
        </tr>`).join('');
}

// 버전 최종 확정
async function confirmVersion(vId) {
    if(!confirm("이 버전을 최종 확정할까요? 확정 후에는 수정이 불가능하며 실제 조사에 사용됩니다.")) return;
    const res = await fetch(`/questionnaire/version/${vId}/confirm/`, { 
        method: 'POST', 
        headers: {'X-CSRFToken': '{{ csrf_token }}'} 
    });
    if(res.ok) { 
        alert('확정되었습니다.'); 
        showVersions(currentQId, ''); 
    }
}

// 조사표 삭제
async function deleteQuestionnaire(qId) {
    if (!confirm("조사표를 삭제하면 관련 모든 버전과 데이터가 삭제됩니다. 정말 삭제하시겠습니까?")) return;
    const res = await fetch(`/questionnaire/${qId}/delete/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    });
    if (res.ok) location.reload();
}

/**
 * [Vue 작업대 실행 함수]
 * @param {number} id - 조사표 마스터 ID
 * @param {string} name - 조사표 명칭
 * @param {Array} designData - 기존 설계 데이터 (JSON)
 * @param {number} versionId - 현재 편집할 버전의 PK (신규일 경우 null)
 */
function openDesignModal(id, name, designData = [], versionId = null) {
    currentQId = id;

    // 1. 매립된 문항 항목 풀 데이터 읽기
    const poolElement = document.getElementById('item-pool-data');
    const questionPool = poolElement ? JSON.parse(poolElement.textContent) : [];

    // 2. 모달 표시
    const modalElement = document.getElementById('designModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    // 3. Vue 앱으로 초기화 데이터 전송
    setTimeout(() => {
        window.dispatchEvent(new CustomEvent('init-survey-editor', { 
            detail: { 
                surveyId: id, 
                surveyName: name, 
                initialData: designData,
                versionId: versionId,
                questionPool: questionPool 
            } 
        }));
    }, 1000); 
}
</script>

    <!-- <script type="module" src="http://127.0.0.1:3000/@vite/client"></script> -->
    <!-- <script type="module" src="http://127.0.0.1:3000/src/main.js"></script> -->

{% vite_hmr_client %}
{% vite_asset 'src/main.js' %}
{% endblock %}