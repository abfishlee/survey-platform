{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>[2단계: 명부설계] {{ survey.survey_name }}</h2>
        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary">목록으로</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">1. 명부 등록/관리</div>
                <div class="card-body">
                    <form id="rosterForm" class="mb-3">
                        <div class="mb-2">
                            <input type="text" id="rosterName" class="form-control form-control-sm" placeholder="명부명 (예: 가구명부)">
                        </div>
                        <div class="mb-2">
                            <select id="parentRoster" class="form-select form-select-sm">
                                <option value="">--- 상위 명부 선택 (옵션) ---</option>
                                {% for r in rosters %}
                                <option value="{{ r.id }}">{{ r.roster_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm w-100" onclick="createRoster()">명부 신규 생성</button>
                    </form>
                    <hr>
                    <div class="list-group">
                        {% for r in rosters %}
                        <button class="list-group-item list-group-item-action {% if forloop.first %}active{% endif %}" 
                                onclick="loadRosterConfig({{ r.id }})">
                            {{ r.roster_name }} {% if r.parent_roster %}<small>(하위)</small>{% endif %}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="configArea">
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span id="selectedRosterTitle">명부를 선택하세요</span>
                        <button class="btn btn-light btn-sm" onclick="saveMapping()">맵핑 설정 저장</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr class="table-light">
                                    <th class="text-center">사용</th>
                                    <th>항목ID</th>
                                    <th>항목명</th>
                                    <th class="text-center">표출</th>
                                    <th class="text-center">검색</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-body">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="card border-warning">
                    <div class="card-header bg-warning fw-bold">명부 데이터 업로드 (CSV)</div>
                    <div class="card-body d-flex gap-2">
                        <a href="{% url 'download_template' survey.id %}" class="btn btn-outline-dark btn-sm">양식 다운로드</a>
                        <input type="file" id="csvFile" class="form-control form-control-sm w-50" accept=".csv">
                        <button class="btn btn-dark btn-sm" onclick="importCSV()">데이터 업로드</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let itemPool = {{ item_pool|safe|default:"[]" }};
let currentRosterId = null;

async function createRoster() {
    const name = document.getElementById('rosterName').value;
    const parent = document.getElementById('parentRoster').value;
    const response = await fetch(window.location.href, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({ roster_name: name, parent_id: parent })
    });
    if(response.ok) location.reload();
}

function loadRosterConfig(id) {
    currentRosterId = id;
    // 실제 운영시에는 서버에서 해당 roster의 mapping_config를 가져와야 함
    // 여기서는 파일럿을 위해 전체 풀을 보여줌
    const tbody = document.getElementById('mapping-body');
    tbody.innerHTML = itemPool.map((item, idx) => `
        <tr>
            <td class="text-center"><input type="checkbox" class="map-check" data-id="${item.id}" checked></td>
            <td><code>${item.id}</code></td>
            <td>${item.label}</td>
            <td class="text-center"><input type="checkbox" class="show-check" data-id="${item.id}"></td>
            <td class="text-center"><input type="checkbox" class="search-check" data-id="${item.id}"></td>
        </tr>
    `).join('');
}

async function saveMapping() {
    if(!currentRosterId) return;
    const config = itemPool.map(item => {
        const row = document.querySelector(`input[data-id="${item.id}"].map-check`);
        return {
            ...item,
            is_mapped: row.checked,
            show_in_list: document.querySelector(`input[data-id="${item.id}"].show-check`).checked,
            is_search: document.querySelector(`input[data-id="${item.id}"].search-check`).checked
        };
    });

    const res = await fetch(`/roster/${currentRosterId}/save_config/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({ mapping_config: config })
    });
    if(res.ok) alert('설정이 저장되었습니다.');
}

async function importCSV() {
    if(!currentRosterId) return alert('명부를 먼저 선택하세요.');
    const formData = new FormData();
    formData.append('csv_file', document.getElementById('csvFile').files[0]);
    const res = await fetch("{% url 'import_roster' survey.id %}", {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData
    });
    const result = await res.json();
    alert(result.message);
}
</script>
{% endblock %}