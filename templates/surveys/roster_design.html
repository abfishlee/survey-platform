{% extends 'base.html' %}
{% load survey_tags %} {% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-card-list"></i> [2단계: 명부설계] {{ survey.survey_name }}</h2>
        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary">목록으로</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-dark text-white fw-bold">1. 명부 등록/관리</div>
                <div class="card-body bg-light">
                    <div class="mb-2">
                        <input type="text" id="rosterName" class="form-control form-control-sm" placeholder="명부명 (예: 가구명부)">
                    </div>
                    <div class="mb-3">
                        <select id="parentRoster" class="form-select form-select-sm">
                            <option value="">--- 상위 명부 선택 (옵션) ---</option>
                            {% for r in rosters %}
                            <option value="{{ r.id }}">{{ r.roster_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm w-100 mb-3" onclick="createRoster()">명부 신규 생성</button>
                    <hr>
                    <div class="list-group shadow-sm">
                        {% for r in rosters %}
                        <button class="list-group-item list-group-item-action roster-item-btn" id="btn-{{ r.id }}"
                                onclick="loadRosterConfig({{ r.id }}, '{{ r.roster_name }}')">
                            <i class="bi bi-folder2-open me-2"></i>{{ r.roster_name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="configArea">
                <div class="card mb-4 border-primary shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span id="selectedRosterTitle" class="fw-bold">명부를 선택하세요</span>
                        <button class="btn btn-light btn-sm fw-bold px-3 shadow-sm" onclick="saveMapping()">맵핑 설정 저장</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light text-center">
                                <tr>
                                    <th style="width: 60px;">사용</th>
                                    <th>항목ID</th>
                                    <th class="text-start">항목명</th>
                                    <th style="width: 80px;">표출</th>
                                    <th style="width: 80px;">검색</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-body" class="text-center">
                                <tr><td colspan="5" class="py-5 text-muted">왼쪽 리스트에서 명부를 클릭해 주세요.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card border-warning shadow-sm">
                    <div class="card-header bg-warning fw-bold">명부 데이터 업로드 (CSV)</div>
                    <div class="card-body d-flex gap-2">
                        <a href="{% url 'download_template' survey.id %}" class="btn btn-outline-dark btn-sm">양식 다운로드</a>
                        <input type="file" id="csvFile" class="form-control form-control-sm w-50" accept=".csv">
                        <button class="btn btn-dark btn-sm" onclick="importCSV()">데이터 업로드</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * 1. 변수 선언 및 초기화
 * ReferenceError 방지를 위해 선언부를 최상단에 배치하고, json_encode 필터를 사용합니다.
 */
let currentRosterId = null;
const itemPool = {{ item_pool|json_encode|safe|default:"[]" }};

// 명부 신규 생성
async function createRoster() {
    const name = document.getElementById('rosterName').value;
    const parent = document.getElementById('parentRoster').value;

    if (!name.trim()) {
        alert('명부명을 입력해 주세요!');
        document.getElementById('rosterName').focus();
        return;
    }

    const res = await fetch(window.location.href, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({ roster_name: name, parent_id: parent })
    });
    if (res.ok) location.reload();
}

// 명부 선택 시 설정값 불러오기
async function loadRosterConfig(id, name) {
    currentRosterId = id;
    document.getElementById('selectedRosterTitle').innerText = `[${name}] 항목 맵핑 설정`;
    
    // UI 활성화 표시
    document.querySelectorAll('.roster-item-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${id}`).classList.add('active');

    try {
        const res = await fetch(`/roster/${id}/get-config/`);
        const data = await res.json();
        const savedConfig = data.mapping_config || [];

        const tbody = document.getElementById('mapping-body');
        tbody.innerHTML = itemPool.map(item => {
            const saved = savedConfig.find(c => c.id === item.id) || {};
            // 기존 설정이 없으면 기본적으로 '사용' 체크됨
            const isMapped = saved.is_mapped !== undefined ? saved.is_mapped : true;
            return `
                <tr>
                    <td><input type="checkbox" class="map-check" data-id="${item.id}" ${isMapped ? 'checked' : ''}></td>
                    <td><code>${item.id}</code></td>
                    <td class="text-start">${item.label}</td>
                    <td><input type="checkbox" class="show-check" data-id="${item.id}" ${saved.show_in_list ? 'checked' : ''}></td>
                    <td><input type="checkbox" class="search-check" data-id="${item.id}" ${saved.is_search ? 'checked' : ''}></td>
                </tr>`;
        }).join('');
    } catch (e) {
        console.error(e);
        alert('설정값을 불러오는데 실패했습니다.');
    }
}

// 맵핑 설정 저장
async function saveMapping() {
    if(!currentRosterId) return alert('명부를 먼저 선택하세요.');
    
    const config = itemPool.map(item => {
        const mapEl = document.querySelector(`.map-check[data-id="${item.id}"]`);
        const showEl = document.querySelector(`.show-check[data-id="${item.id}"]`);
        const searchEl = document.querySelector(`.search-check[data-id="${item.id}"]`);
        
        return {
            ...item,
            is_mapped: mapEl ? mapEl.checked : true,
            show_in_list: showEl ? showEl.checked : false,
            is_search: searchEl ? searchEl.checked : false
        };
    });

    const res = await fetch(`/roster/${currentRosterId}/save-config/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({ mapping_config: config })
    });
    
    if(res.ok) alert('설정이 성공적으로 저장되었습니다.');
    else alert('저장에 실패했습니다.');
}

// CSV 업로드
async function importCSV() {
    if(!currentRosterId) return alert('명부를 먼저 선택하세요.');
    const fileInput = document.getElementById('csvFile');
    if(!fileInput.files[0]) return alert('파일을 선택하세요.');

    const formData = new FormData();
    formData.append('csv_file', fileInput.files[0]);
    
    try {
        const res = await fetch("{% url 'import_roster' survey.id %}", {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: formData
        });
        const result = await res.json();
        alert(result.message || '업로드 완료');
    } catch (e) {
        alert('업로드 중 시스템 오류가 발생했습니다.');
    }
}
</script>
{% endblock %}